<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.apollo.task.dao.TaskDAO">

    <select id="getTasks" parameterType="String" resultType="com.apollo.vo.TaskDTO">
    select * from task where pid = #{pid}
    </select>
    
    <select id="getAssignedTasks" parameterType="String" resultType="com.apollo.vo.TaskDTO">
    select * from task where pid=#{pid} and tid in (select tid from assignee)
    </select>
	    
    <select id="getNotAssignedTasks" parameterType="String" resultType="com.apollo.vo.TaskDTO">
    select * from task where pid=#{pid} and tid not in (select tid from assignee)
    </select>
    
    <select id="getTasksInSteps" parameterType="String" resultType="com.apollo.vo.TaskDTO">
    select * from taskinstep where sid = #{sid}
    </select>

    <select id="getTasksByStepId"  resultType="com.apollo.vo.TaskDTO">
    select t.*, s.tstatus, s.color 
    from task t join tstatus s on t.tstatusid = s.tstatusid 
    where tid in (select tid from taskinstep where sid= #{sid}) order by t.ctime
    </select>
    
    <update id="updateTask" parameterType="com.apollo.vo.TaskDTO">
    	update task set
      <if test="tname != null">tname=#{tname},</if>
      <if test="sday != null">sday=TO_DATE(#{sday},'YYYY-MM-DD HH24:MI:SS'),</if>
      <if test="eday != null">eday=TO_DATE(#{eday},'YYYY-MM-DD HH24:MI:SS'),</if>
      <if test="detail != null">detail=#{detail},</if>
      <if test="importance != 0">importance=#{importance},</if>
      <if test="tstatusid != 0">tstatusid=#{tstatusid},</if>
     	ctime= sysdate 
    	where tid= #{tid}
    </update>
    
    <insert id="insertBoardTask" parameterType="com.apollo.vo.TaskDTO">
    	 <selectKey keyProperty="tid" resultType="int" order="BEFORE">
        	  select seq_tid.nextval FROM DUAL
   		 </selectKey>
    	insert into task(tid, tname, pid, ctime, tstatusid) values(#{tid}, #{tname}, #{pid}, sysdate, #{tstatusid})
    </insert>

    <insert id="insertBoardTaskInStep" parameterType="com.apollo.vo.TaskInStepDTO">
    	insert into taskinstep values(#{sid}, #{tid})
    </insert>
  
    <select id="getTask" parameterType="String" resultType="com.apollo.vo.TaskDTO">
    	select * from task where tid = #{tid}
    </select>
     
    <delete id="deleteTask">
    	delete from task where tid = #{tid}
    </delete>
    

    <delete id="deleteStepInTaskModal" parameterType="com.apollo.vo.TaskInStepDTO">
    	delete from taskinstep where sid = #{sid} and tid = #{tid}
    </delete>
	
	<select id="countTaskInStep" resultType="Integer">
		select count(*) from taskinstep where tid = #{tid}
	</select>    

    
    <select id="getTasksAndTstatusInStep"  parameterType="java.util.List" resultType="com.apollo.vo.TaskDTO">
		select * from taskinstep tis join task t on tis.tid = t.tid join TSTATUS tt
		on tt.TSTATUSID  = t.TSTATUSID where 
		tis.sid in
		<foreach collection="list" item="step"  open="(" close=")" separator=",">
			#{step.sid}
		</foreach>
    </select>
	
	<update id="changeTstatus" parameterType="com.apollo.vo.TidvalueDTO">
		update task set tstatusid = #{value} where tid = #{tid}
	</update>

    <insert id="addTaskInStepInTaskModal" parameterType="com.apollo.vo.TaskInStepDTO">
		insert into taskinstep values(#{sid}, #{tid})
	</insert>

    <select id ="selectTasksByMidAndSid" parameterType="hashmap" resultType="com.apollo.vo.TaskDTO">
    	select t.*, s.tstatus, s.color 
    	from task t join tstatus s on t.tstatusid = s.tstatusid 
    	where tid in (select tid from taskinstep 
    	where sid= #{sid} and tid in(select tid from assignee 
    	where mid= #{mid}))
    </select>


	<select id="getRecentTasks" resultType="com.apollo.vo.TaskDTO">
		select * from task t join tstatus s 
		on t.tstatusid = s.tstatusid 
		where (ctime between sysdate-3 and sysdate) 
		and pid in (select pid from pmember where mid =#{mid}) 
		and rownum &lt;= 10 order by tid desc
	</select>
    
    <select id ="getSearchTasks" parameterType="hashmap" resultType="com.apollo.vo.TaskDTO">
	    select * from task t join tstatus s 
		on t.tstatusid = s.tstatusid 
		where tname like '%'||#{input}||'%'
		and pid in (select pid from pmember where mid =#{mid}) order by tid desc
    </select>

	
	<delete id="deleteAssignee" parameterType="com.apollo.vo.MidtidDTO">
    	delete from assignee where mid = #{mid} and tid = #{tid}
    </delete>
    
    <select id ="selectNotAssignedTasksBySid" resultType="com.apollo.vo.TaskDTO">
   	 select * from 
   	 task t join tstatus s 
	 on t.tstatusid = s.tstatusid 
   	 where tid in (select tid from taskinstep where sid=#{sid}) 
   	 and tid not in (select tid from assignee)
    </select>

    <update id="changeSdayOfTask" parameterType="com.apollo.vo.TaskDTO">
    	update task set sday= #{sday} where tid = #{tid}
    </update>
    
     <update id="changeEdayOfTask" parameterType="com.apollo.vo.TaskDTO">
    	update task set eday= #{eday} where tid = #{tid}
    </update>
    
    <select id="getTname" resultType="String">
    	select tname from task where tid = #{tid}
    </select>
    
    <update id="changeTname" parameterType="com.apollo.vo.TaskDTO">
		update task set tname = #{tname} where tid = #{tid}
	</update>
    
</mapper>
